#!/usr/bin/env python3
"""
MyCasa Pro CLI Entry Point
Bootstraps a local venv + deps if needed, then runs the CLI.
"""
import os
import sys
import shutil
import subprocess
from pathlib import Path

REPO_DIR = Path(__file__).resolve().parent

def _venv_python(venv_dir: Path) -> Path:
    if os.name == "nt":
        return venv_dir / "Scripts" / "python.exe"
    return venv_dir / "bin" / "python"

def _ensure_deps() -> None:
    try:
        import click  # noqa: F401
        return
    except Exception:
        pass

    venv_dir = REPO_DIR / ".venv"
    venv_py = _venv_python(venv_dir)
    if not venv_py.exists():
        system_py = shutil.which("python3") or shutil.which("python")
        if not system_py:
            print("‚ùå Python not found. Install Python 3.11+ and retry.")
            sys.exit(1)
        subprocess.check_call([system_py, "-m", "venv", str(venv_dir)])
    # Install requirements into venv
    subprocess.check_call([str(venv_py), "-m", "pip", "install", "-r", str(REPO_DIR / "requirements.txt")])
    # Re-exec inside venv
    os.execv(str(venv_py), [str(venv_py), str(__file__), *sys.argv[1:]])

def main():
    _ensure_deps()
    sys.path.insert(0, str(REPO_DIR))
    from backend.cli.main import cli
    cli()

if __name__ == "__main__":
    main()
