<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claw Playground ‚Äî pE-67shfX6</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c121a;
      --text:#e6edf6;
      --muted:#9fb0c3;
      --hair:rgba(255,255,255,.10);
      --hair2:rgba(255,255,255,.06);
      --ok:#2ee59d;
      --idle:#6b7a8a;
      --bad:#ff4d4d;
      --accent:#6366f1;
      --r:14px;
      --sp:8px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1100px 700px at 30% 0%, rgba(99,102,241,.08), transparent 60%), var(--bg);
      color:var(--text);
      font: 14px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .top{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--hair2)}
    .title{font-size:16px;font-weight:650;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .wrap{display:grid;grid-template-columns: 320px 1fr 340px; gap:12px; padding:12px; height: calc(100vh - 64px);}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 22%), var(--panel); border:1px solid var(--hair2); border-radius: var(--r); overflow:hidden}
    .card h3{margin:0;padding:12px 12px 8px;font-size:12px;color:var(--muted);font-weight:650;letter-spacing:.12em;text-transform:uppercase}
    .pad{padding:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .chip{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--hair2); border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%), var(--panel2); cursor:pointer; transition: border-color .15s}
    .chip:hover{border-color:rgba(99,102,241,.4)}
    .chip.selected{border-color:var(--ok);background:rgba(46,229,157,.05)}
    .avatar{width:40px;height:40px;border-radius:999px;border:2px solid rgba(255,255,255,.10); background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.10), transparent 55%), linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.02)); box-shadow: 0 8px 18px rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;font-size:16px}
    .ring-ok{border-color: rgba(46,229,157,.9)}
    .ring-idle{border-color: rgba(159,176,195,.55)}
    .name{font-weight:650}
    .meta{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--muted); padding:4px 8px;border:1px solid var(--hair2);border-radius:999px;background:rgba(255,255,255,.02)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--idle)}
    .dot.ok{background:var(--ok)}
    .btn{cursor:pointer;border:1px solid var(--hair2);background:rgba(255,255,255,.02); color:var(--text);padding:10px 14px;border-radius:12px;font-weight:650;transition:all .15s}
    .btn:hover{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
    .btn.primary{background:linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);border-color:transparent}
    .btn.primary:hover{opacity:.9}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .in{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--hair2); background:rgba(0,0,0,.25);color:var(--text);outline:none;font-family:inherit}
    .in:focus{border-color:rgba(99,102,241,.55)}
    .canvas{height:100%;display:flex;flex-direction:column}
    .stage{flex:1;border-top:1px solid var(--hair2);background:radial-gradient(800px 500px at 50% 30%, rgba(255,255,255,.03), transparent 60%);overflow:auto}
    svg{width:100%;height:100%;min-height:600px}
    .node{cursor:pointer}
    .node rect{fill:rgba(255,255,255,.03);stroke:rgba(255,255,255,.12);stroke-width:1;transition:all .15s}
    .node:hover rect{fill:rgba(255,255,255,.06);stroke:rgba(99,102,241,.5)}
    .node text{fill:var(--text);font-weight:650;font-size:12px}
    .node .kind{fill:rgba(159,176,195,.85);font-weight:600;font-size:11px}
    .edge{stroke:rgba(159,176,195,.25);stroke-width:1.2;marker-end:url(#arrow)}
    .edgeLabel{fill:rgba(159,176,195,.7);font-size:10px}
    .sel rect{stroke: rgba(46,229,157,.9);stroke-width:1.6;fill:rgba(46,229,157,.05)}
    .small{font-size:12px;color:var(--muted)}
    .kv{display:grid;grid-template-columns: 100px 1fr; gap:6px 10px; align-items:start}
    .k{color:rgba(159,176,195,.85);font-size:12px}
    .v{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; color: rgba(230,237,246,.92); white-space:pre-wrap;word-break:break-all}
    .stats{display:flex;gap:16px;padding:8px 12px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:12px}
    .stat{text-align:center}
    .stat-val{font-size:20px;font-weight:700;color:var(--accent)}
    .stat-label{font-size:11px;color:var(--muted)}
    .decisions-list{max-height:150px;overflow-y:auto;margin-top:8px}
    .decision-item{padding:6px 8px;background:rgba(0,0,0,.2);border-radius:6px;margin-bottom:4px;font-size:11px;font-family:monospace}
    @media(max-width:1200px){
      .wrap{grid-template-columns:1fr;height:auto}
      .canvas{min-height:500px}
    }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <div class="title">üîß Playground Session <span style="opacity:.7">#pE-67shfX6</span></div>
      <div class="sub">Visualize & decide ‚Üí Export ‚Üí Janitor applies changes.</div>
    </div>
    <div class="row">
      <button class="btn" id="reload">‚Üª Reload</button>
      <button class="btn primary" id="export">üì§ Export</button>
    </div>
  </div>
  
  <div class="wrap">
    <div class="card">
      <h3>ü§ñ Agents (9)</h3>
      <div class="pad">
        <div class="list" id="agents"></div>
      </div>
      <h3 style="border-top:1px solid var(--hair2);padding-top:12px">üì¶ Modules</h3>
      <div class="pad">
        <div class="list" id="modules" style="max-height:300px;overflow-y:auto"></div>
      </div>
    </div>
    
    <div class="card canvas">
      <h3>üîó System Graph (20 edges)</h3>
      <div class="pad">
        <div class="small" id="goal"></div>
      </div>
      <div class="stage">
        <svg id="svg" viewBox="0 0 1400 800" preserveAspectRatio="xMidYMid meet">
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(159,176,195,.4)"/>
            </marker>
          </defs>
        </svg>
      </div>
    </div>
    
    <div class="card">
      <h3>üîç Inspector</h3>
      <div class="pad">
        <div class="stats">
          <div class="stat"><div class="stat-val" id="selCount">0</div><div class="stat-label">Selected</div></div>
          <div class="stat"><div class="stat-val" id="dcount">0</div><div class="stat-label">Decisions</div></div>
        </div>
        
        <div class="small" style="margin-bottom:8px">Selected node</div>
        <div class="kv" style="margin-bottom:12px">
          <div class="k">id</div><div class="v" id="sid">‚Äî</div>
          <div class="k">type</div><div class="v" id="stype">‚Äî</div>
          <div class="k">file</div><div class="v" id="sfile">‚Äî</div>
        </div>
        
        <div class="small" style="margin:14px 0 8px">Add Decision</div>
        <select class="in" id="decisionType">
          <option value="">‚Äî Select type ‚Äî</option>
          <option value="remove_dependency">üîó remove_dependency</option>
          <option value="add_dependency">‚ûï add_dependency</option>
          <option value="rename">‚úèÔ∏è rename</option>
          <option value="move_file">üìÅ move_file</option>
          <option value="delete_file">üóëÔ∏è delete_file</option>
          <option value="edit_setting">‚öôÔ∏è edit_setting</option>
        </select>
        
        <div class="small" style="margin:10px 0 8px">Args (JSON)</div>
        <textarea class="in" id="decisionArgs" rows="4" spellcheck="false">{}</textarea>
        
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addDecision">+ Add</button>
          <button class="btn" id="clearDecisions" style="opacity:.7">Clear all</button>
        </div>
        
        <div class="small" style="margin:14px 0 8px">Decisions queue</div>
        <div class="decisions-list" id="decisionsList"></div>
        
        <div class="small" style="margin:14px 0 8px">Prompt for Janitor</div>
        <textarea class="in" id="prompt" rows="4" spellcheck="false">Apply exported decisions to the codebase. Update imports, remove unused parts, add tests, run lint.</textarea>
      </div>
    </div>
  </div>

  <script>
    const state = {
      sessionId: "pE-67shfX6",
      payload: null,
      selectedNode: null,
      decisions: [],
      selections: { agents: [], modules: [], nodes: [], edges: [] }
    };

    async function loadPayload() {
      try {
        const res = await fetch("./payload.json", { cache: "no-store" });
        state.payload = await res.json();
        document.getElementById("goal").textContent = "üéØ Goal: " + state.payload.goal;
        renderAgents();
        renderModules();
        renderGraph();
      } catch (e) {
        console.error("Failed to load payload:", e);
      }
    }

    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") n.className = v;
        else if (k.startsWith("on")) n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      }
      for (const c of children) {
        n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      }
      return n;
    }

    function getAgentEmoji(id) {
      const emojis = {
        manager: "üè†", finance: "üí∞", maintenance: "üîß", security: "üõ°Ô∏è",
        contractors: "üë∑", projects: "üìã", janitor: "‚ú®", base: "üî®"
      };
      return emojis[id] || "ü§ñ";
    }

    function renderAgents() {
      const wrap = document.getElementById("agents");
      wrap.innerHTML = "";
      const agents = state.payload.snapshot.agents || [];
      
      agents.forEach(a => {
        const status = a.status || "idle";
        const ring = status === "active" ? "ring-ok" : "ring-idle";
        const dot = status === "active" ? "dot ok" : "dot";
        const isSelected = state.selections.agents.includes(a.id);
        
        const chip = el("div", { 
          class: "chip" + (isSelected ? " selected" : ""), 
          onclick: () => { toggleSelection("agents", a.id); renderAgents(); }
        }, [
          el("div", { class: "avatar " + ring }, [getAgentEmoji(a.id)]),
          el("div", {}, [
            el("div", { class: "name" }, [a.label || a.id]),
            el("div", { class: "meta" }, [
              el("span", { class: "pill" }, [
                el("span", { class: dot }),
                status.toUpperCase()
              ])
            ])
          ])
        ]);
        wrap.appendChild(chip);
      });
    }

    function renderModules() {
      const wrap = document.getElementById("modules");
      wrap.innerHTML = "";
      const modules = state.payload.snapshot.modules || [];
      
      const kindEmoji = {
        agent: "ü§ñ", api: "üåê", core: "‚öôÔ∏è", settings: "üìÑ",
        connector: "üîå", memory: "üß†", db: "üíæ", other: "üì¶"
      };
      
      modules.slice(0, 30).forEach(m => {
        const isSelected = state.selections.modules.includes(m.id);
        const chip = el("div", {
          class: "chip" + (isSelected ? " selected" : ""),
          onclick: () => { toggleSelection("modules", m.id); selectNode(m); renderModules(); }
        }, [
          el("div", { class: "avatar", style: "width:32px;height:32px;font-size:14px" }, [kindEmoji[m.kind] || "üì¶"]),
          el("div", {}, [
            el("div", { class: "name", style: "font-size:12px" }, [m.id.split("/").pop() || m.id]),
            el("div", { class: "meta", style: "font-size:11px" }, [m.kind])
          ])
        ]);
        wrap.appendChild(chip);
      });
      
      if (modules.length > 30) {
        wrap.appendChild(el("div", { class: "small", style: "padding:8px;text-align:center" }, 
          ["+" + (modules.length - 30) + " more modules"]));
      }
    }

    function toggleSelection(bucket, id) {
      const arr = state.selections[bucket];
      const i = arr.indexOf(id);
      if (i >= 0) arr.splice(i, 1);
      else arr.push(id);
      updateSelectionCount();
    }

    function updateSelectionCount() {
      const total = state.selections.agents.length + state.selections.modules.length + state.selections.nodes.length;
      document.getElementById("selCount").textContent = String(total);
    }

    function renderGraph() {
      const svg = document.getElementById("svg");
      // Keep defs
      const defs = svg.querySelector("defs");
      svg.innerHTML = "";
      svg.appendChild(defs);
      
      const mods = state.payload.snapshot.modules || [];
      const edges = state.payload.snapshot.edges || [];
      
      // Layout: group by kind
      const groups = { agent: [], api: [], core: [], connector: [], other: [] };
      mods.forEach(m => {
        const g = groups[m.kind] || groups.other;
        g.push(m);
      });
      
      const pos = new Map();
      let y = 60;
      
      // Agents column
      groups.agent.forEach((m, i) => {
        pos.set(m.id, { x: 80, y: y + i * 80 });
      });
      
      // Core column
      const coreY = 60;
      [...groups.core, ...groups.connector].forEach((m, i) => {
        pos.set(m.id, { x: 420, y: coreY + i * 70 });
      });
      
      // API column
      groups.api.forEach((m, i) => {
        pos.set(m.id, { x: 760, y: 60 + i * 60 });
      });
      
      // Other
      groups.other.forEach((m, i) => {
        pos.set(m.id, { x: 1050, y: 60 + i * 60 });
      });

      // Draw edges first
      edges.forEach(e => {
        const a = pos.get(e.from), b = pos.get(e.to);
        if (!a || !b) return;
        
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", a.x + 200);
        line.setAttribute("y1", a.y + 28);
        line.setAttribute("x2", b.x);
        line.setAttribute("y2", b.y + 28);
        line.setAttribute("class", "edge");
        svg.appendChild(line);
        
        if (e.label) {
          const tx = (a.x + 200 + b.x) / 2;
          const ty = (a.y + 28 + b.y + 28) / 2 - 8;
          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.setAttribute("x", tx);
          t.setAttribute("y", ty);
          t.setAttribute("class", "edgeLabel");
          t.textContent = e.label;
          svg.appendChild(t);
        }
      });

      // Draw nodes
      mods.forEach(m => {
        const p = pos.get(m.id);
        if (!p) return;
        
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("class", "node");
        g.setAttribute("transform", "translate(" + p.x + "," + p.y + ")");
        g.setAttribute("data-id", m.id);
        g.addEventListener("click", () => selectNode(m));
        
        const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        r.setAttribute("rx", "12");
        r.setAttribute("ry", "12");
        r.setAttribute("width", "200");
        r.setAttribute("height", "56");
        g.appendChild(r);
        
        const t1 = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t1.setAttribute("x", "12");
        t1.setAttribute("y", "24");
        t1.textContent = m.id.length > 24 ? m.id.slice(0, 22) + "‚Ä¶" : m.id;
        g.appendChild(t1);
        
        const t2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t2.setAttribute("x", "12");
        t2.setAttribute("y", "42");
        t2.setAttribute("class", "kind");
        t2.textContent = m.kind;
        g.appendChild(t2);
        
        svg.appendChild(g);
      });
      
      updateSelectionHighlight();
    }

    function selectNode(m) {
      state.selectedNode = m;
      if (!state.selections.nodes.includes(m.id)) {
        state.selections.nodes.push(m.id);
      }
      document.getElementById("sid").textContent = m.id;
      document.getElementById("stype").textContent = m.kind;
      document.getElementById("sfile").textContent = m.file || "‚Äî";
      
      // Pre-fill args based on selected node
      document.getElementById("decisionArgs").value = JSON.stringify({ target: m.id }, null, 2);
      
      updateSelectionHighlight();
      updateSelectionCount();
    }

    function updateSelectionHighlight() {
      const svg = document.getElementById("svg");
      [...svg.querySelectorAll(".node")].forEach(n => {
        n.classList.remove("sel");
        const id = n.getAttribute("data-id");
        if (state.selectedNode && id === state.selectedNode.id) {
          n.classList.add("sel");
        }
      });
    }

    function renderDecisions() {
      const list = document.getElementById("decisionsList");
      list.innerHTML = "";
      state.decisions.forEach((d, i) => {
        const item = el("div", { class: "decision-item" }, [
          (i + 1) + ". " + d.type + ": " + JSON.stringify(d).slice(0, 60) + "‚Ä¶"
        ]);
        list.appendChild(item);
      });
      document.getElementById("dcount").textContent = String(state.decisions.length);
    }

    document.getElementById("addDecision").addEventListener("click", () => {
      const type = document.getElementById("decisionType").value;
      if (!type) { alert("Select a decision type"); return; }
      
      let args = {};
      try {
        args = JSON.parse(document.getElementById("decisionArgs").value || "{}");
      } catch (e) {
        alert("Invalid JSON in args");
        return;
      }
      
      const d = { type, ...args };
      state.decisions.push(d);
      renderDecisions();
      
      // Clear form
      document.getElementById("decisionType").value = "";
      document.getElementById("decisionArgs").value = "{}";
    });

    document.getElementById("clearDecisions").addEventListener("click", () => {
      if (confirm("Clear all decisions?")) {
        state.decisions = [];
        renderDecisions();
      }
    });

    document.getElementById("export").addEventListener("click", async () => {
      const payload = {
        version: "1.0",
        sessionId: state.sessionId,
        createdAt: new Date().toISOString(),
        goal: state.payload.goal,
        selections: state.selections,
        decisions: state.decisions,
        uiTokens: {
          avatarStyle: "photoreal_chip",
          border: "hairline",
          radius: 14,
          spacing: 8,
          density: "compact"
        },
        promptToApply: document.getElementById("prompt").value || ""
      };
      
      try {
        const res = await fetch("/api/export", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          alert("‚úÖ Exported successfully!\n\nJanitor can now consume export.json");
        } else {
          const err = await res.json();
          alert("Export failed: " + JSON.stringify(err));
        }
      } catch (e) {
        alert("Export failed: " + e.message);
      }
    });

    document.getElementById("reload").addEventListener("click", loadPayload);

    // Init
    loadPayload();
  </script>
</body>
</html>